---
- name: Get ansible_user home directory
  ansible.builtin.shell: 'set -o pipefail && getent passwd "{{ ansible_user }}" | cut -d: -f6'
  register: ansible_home_result
  changed_when: false
  tags:
    - config-language
    - config-arm64-m4

- name: Set the fact for the other scripts to use
  ansible.builtin.set_fact: ansible_home={{ ansible_home_result.stdout }}
  changed_when: false
  tags:
    - config-language
    - config-arm64-m4

- name: Install anyenv
  become: true
  become_user: "{{ ansible_user }}"
  ansible.builtin.git:
    repo: https://github.com/riywo/anyenv
    dest: "{{ ansible_home }}/.anyenv"
  tags:
    - config-base

- name: Install anyenv-update
  become: true
  become_user: "{{ ansible_user }}"
  ansible.builtin.git:
    repo: https://github.com/znz/anyenv-update
    dest: "{{ ansible_home }}/.anyenv/plugins/anyenv-update"
  tags:
    - config-base

- name: Place Init File
  become: true
  become_user: "{{ ansible_user }}"
  ansible.builtin.template:
    src: files/anyenv.sh
    dest: "{{ ansible_home }}/.bash.d/anyenv.sh"
    mode: 0755
  with_items:
    - anyenv.sh
  tags:
    - config-base

- name: Init anyenv
  become: true
  become_user: "{{ ansible_user }}"
  ansible.builtin.command: anyenv install --init
  environment:
    ANYENV_ROOT: "{{ ansible_home }}/.anyenv"
  ignore_errors: true
  tags:
    - config-base

- name: Check env installed
  become: true
  become_user: "{{ ansible_user }}"
  ansible.builtin.command: anyenv envs
  register: anyenv_envs
  changed_when: false
  tags:
    - config-base

- name: Install env tools
  become: true
  become_user: "{{ ansible_user }}"
  ansible.builtin.command: "anyenv install {{ item }}"
  with_items:
    - goenv
    - nodenv
    - rbenv
    - tfenv
  environment:
    ANYENV_ROOT: "{{ ansible_home }}/.anyenv"
  when: 'item not in anyenv_envs.stdout'
  ignore_errors: true
  tags:
    - config-base

- name: Update exists tools
  become: true
  become_user: "{{ ansible_user }}"
  ansible.builtin.command: anyenv update
  environment:
    ANYENV_ROOT: "{{ ansible_home }}/.anyenv"
  ignore_errors: true
  tags:
    - config-base
