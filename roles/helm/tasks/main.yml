---
- name: Get os in lowercase
  ansible.builtin.shell: set -o pipefail && uname | tr '[:upper:]' '[:lower:]'
  register: os_result
  changed_when: false
  tags:
    - config-tool
    - config-kubernetes
    - config-helm

- name: Get target arch
  ansible.builtin.shell: set -o pipefail && uname -m | sed -e 's/x86_64/amd64/' -e 's/\(arm\)\(64\)\?.*/\1\2/' -e 's/aarch64$/arm64/'
  register: arch_result
  changed_when: false
  tags:
    - config-tool
    - config-kubernetes
    - config-helm

- name: Add apt signing key
  become: true
  ansible.builtin.apt_key:
    url: https://baltocdn.com/helm/signing.asc
    state: present
    keyring: /usr/share/keyrings/helm.gpg
  tags:
    - config-tool
    - config-kubernetes
    - config-helm

- name: Add apt source
  become: true
  ansible.builtin.apt_repository:
    repo: "deb [arch={{ arch_result.stdout }} signed-by=/usr/share/keyrings/helm.gpg] https://baltocdn.com/helm/stable/debian/ all main"
    state: present
  tags:
    - config-tool
    - config-kubernetes
    - config-helm

- name: Install helm
  become: true
  ansible.builtin.apt:
    name: helm
    state: present
    update_cache: true
  when: not ansible_check_mode
  tags:
    - config-tool
    - config-kubernetes
    - config-helm

# - name: Install Helm Plugin
#   become: true
#   ansible.builtin.command: |
#     helm plugin install https://github.com/futuresimple/helm-secrets
#     helm plugin install https://github.com/databus23/helm-diff --version master
#   tags:
#     - config-tool
#     - config-kubernetes
#     - config-helm

- name: Install Helmfile
  become: true
  ansible.builtin.shell: |
    set -o pipefail
    pushd "$(mktemp -d)"
    bin_name="helmfile_{{ os_result.stdout }}_{{ arch_result.stdout }}"
    curl -s https://api.github.com/repos/roboll/helmfile/releases/latest | jq -r --arg NAME "$bin_name" '.assets[] | select(.name | contains($NAME)) | .browser_download_url' | wget -i -
    chmod +x ${bin_name}
    mv ${bin_name} {{ helmfile_path }}
    popd
  tags:
    - config-tool
    - config-kubernetes
    - config-helm
