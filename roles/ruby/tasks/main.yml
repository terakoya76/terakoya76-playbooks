---
- name: Download ruby-build
  git:
    repo: https://github.com/sstephenson/ruby-build.git
    dest: $HOME/.anyenv/envs/rbenv/plugins/ruby-build
  tags:
    - config-language
    - config-ruby

- name: Check installed ruby version
  shell: bash -lc "rbenv versions"
  register: RBENV_INSTALLED
  changed_when: false
  ignore_errors: yes
  tags:
    - config-language
    - config-ruby

- name: Install ruby from rbenv
  shell: bash -lc "rbenv install {{ item }}"
  with_items: "{{ RUBY_VERSIONS }}"
  when: 'item not in RBENV_INSTALLED.stdout'
  tags:
    - config-language
    - config-ruby

- name: Set Global version
  shell: bash -lc "rbenv global {{ GLOBAL_RUBY_VERSION }}"
  tags:
    - config-language
    - config-ruby

- name: Install bundler
  gem:
    name: bundler
    executable: "$HOME/.anyenv/envs/rbenv/versions/{{ item }}/bin/gem"
    state: present
    user_install: no
  with_items: "{{ RUBY_VERSIONS }}"
  tags:
    - config-language
    - config-ruby

- name: update rubygem
  shell: "$HOME/.anyenv/envs/rbenv/versions/{{ item }}/bin/gem update --system --no-document"
  register: gem_update
  with_items: "{{ RUBY_VERSIONS }}"
  changed_when: gem_update.stdout.find('Latest version already installed') == -1
  tags:
    - config-language
    - config-ruby
